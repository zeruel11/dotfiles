#!/bin/bash
#calibre sync

#$FD='/k/[modWorks]/'
#$PHD='/g/modSource/'

if [ "$1" == 'pull' ]; then
	if [ -d "/f/[modWorks]/" ]; then
		echo -e '\e[34mExternal master source exist, synchronizing...\e[0m'
		if [ "$2" == 'confirm' ]; then
			rsync -Cuazv /f/\[modWorks\]/fallout4-vortex/ "/c/Users/zeruel11/AppData/Roaming/Vortex/fallout4" --delete
			rsync -Cuazv --filter="merge .filter-ESP" /f/\[modWorks\]/esps/ "/d/FO4/Data/" --delete | tee ~/sync-modWorks.X230-rebase.MASTER.log
		else
			rsync -Cuazvn /f/\[modWorks\]/fallout4-vortex/ "/c/Users/zeruel11/AppData/Roaming/Vortex/fallout4" --delete
			rsync -Cuazvn --filter="merge .filter-ESP" /f/\[modWorks\]/esps/ "/d/FO4/Data/" --delete | tee ~/sync-modWorks.DRY_RUN.log
			echo -e '\e[41;97mThis dry run MUST be used as \e[1mREFERENCE\e[0m'
		fi
	elif [ -d "/j/gaming/" ]; then
		rsync -Cuazvn /d/WorkSpace/\=modding\=/FO4/Data/ "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" | tee ~/sync-modWorks.DRY_RUN.log
		echo 'due to the complex nature of modding it is A MUST that you copy the resulting files manually'
	elif [ -d "/d/FO4/" ]; then
		if [ "$2" == 'confirm' ]; then
			rsync -Cuazv --progress /d/_modWorks/\=modding\=/FO4/Data/ /d/FO4/Data/ | tee ~/sync-modWorks.X230-pull.log
		else
			rsync -Cuazvn --progress /d/_modWorks/\=modding\=/FO4/Data/ /d/FO4/Data/ | tee ~/sync-modWorks.DRY_RUN.log
			echo -e '\e[41;97mThis dry run MUST be used as \e[1mREFERENCE\e[0m'
		fi
	else
		echo -e '\e[31mNo source and nowhere to pull :(\e[0m'
	fi
elif [ "$1" == 'export' ]; then
	if [ -z "$2" ]; then
		cp -v /d/WorkSpace/\=modding\=/FO4/BodySlideResult/* /c/Users/zeruel/Desktop/
	else
		cp -v /d/WorkSpace/\=modding\=/FO4/BodySlideResult/* $2
	fi
elif [ "$1" == 'master' ]; then
	if [ -d "/k/[modWorks]/" ]; then
		rsync -Cuazv --filter="merge .filter-espBA2" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /k/\[modWorks\]/esps/ --delete --delete-excluded
	else
		echo -e "\e[41mYour portable flashdisk is not present or uses a different drive map\e[0m"
	fi
	if [ -d "/g/modSource/" ]; then
		rsync -Cuazv --filter="merge .filter-MasterSync" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /g/modSource/Data/ --delete --delete-excluded
	else
		echo -e "\e[41mYour portable harddisk is not present or uses a different drive map\e[0m"
	fi
elif [ "$1" == 'push' ]; then
	read -p "Do you want to push models or esp? " whattopush
	if [ -d "/d/FO4/" ]; then
		echo -e "\e[34mDirectory D:\\FO4 found. Copying esp..."
		rsync -azv /d/FO4/Data/myCompatibilityPatches.esp "/d/_modWorks/=modding=/FO4/"
	elif [ -d "/j/gaming/illegal, no-drm, and freebies/Fallout 4/" ] && [ "$whattopush" == "models" ]; then
		previewFull=$(rsync -Cuazvvn --filter="merge .filter-Data" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /d/WorkSpace/\=modding\=/FO4/Data/ --delete-before --delete-excluded --max-size=300m)
		preview=$(rsync -Cuazvn --filter="merge .filter-Data" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /d/WorkSpace/\=modding\=/FO4/Data/ --delete-before --delete-excluded --max-size=300m)
		echo "$preview"
		echo "$previewFull" | grep --color=always "over max-size"
		#previewFilter=$(echo "$preview" )
#		echo "$preview" | egrep "^((?!sender).)*$"
#		echo "$preview" | grep "over max-size"
		read -p "Confirm push? [yes/list] " confirmModel
		if [ "$confirmModel" == "yes" ]; then
			rsync -Cuazvv --filter="merge .filter-Data" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /d/WorkSpace/\=modding\=/FO4/Data/ --delete-before --delete-excluded --max-size=300m
		elif [ "$confirmModel" == "list" ]; then
			rsync -Cuazvvn --filter="merge .filter-Data" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /d/WorkSpace/\=modding\=/FO4/Data/ --delete-before --delete-excluded --max-size=300m > .sync-modWorks_lastDryRun.log
		else
			echo -e "\e[34mSynchronization canceled...\e[0m"
		fi
	elif [ -d "/j/gaming/illegal, no-drm, and freebies/Fallout 4/" ] && [ "$whattopush" == "esp" ]; then
		rsync -cazv "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/myCompatibilityPatches.esp" "/d/WorkSpace/=modding=/FO4/Data/"
	else
		echo -e "You're neither at your pc nor your laptop... \e[31mWho or where the fluff are you?!\e[0m"
	fi
else
	echo 'you have to specify pull or push (mastersync), or export to Desktop'
fi
