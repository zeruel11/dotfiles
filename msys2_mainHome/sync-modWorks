#!/bin/bash
#calibre sync

#$FD='/k/[modWorks]/'
#$PHD='/g/modSource/'

if [ -d "/d/FO4/" ]; then
	FO4="portable"
	echo -e "\e[44mDirectory D:\\FO4 found. Using portable version...\e[0m"
elif [ -d "/j/gaming/illegal, no-drm, and freebies/Fallout 4/" ]; then
	FO4="main"
	echo -e "\e[44mDirectory J:\\gaming\\Fallout 4 found. Using main version...\e[0m"
fi

if [ "$1" == 'pull' ]; then
	if [ -d "/f/[modWorks]/" ]; then
		echo -e '\e[34mExternal master source exist, synchronizing...\e[0m'
		if [ "$2" == 'confirm' ]; then
			rsync -Cuazv /f/\[modWorks\]/fallout4-vortex/ "/c/Users/zeruel11/AppData/Roaming/Vortex/fallout4" --delete
			rsync -Cuazv --filter="merge .filter-ESP" /f/\[modWorks\]/esps/ "/d/FO4/Data/" --delete | tee ~/sync-modWorks.X230-rebase.MASTER.log
		else
			rsync -Cuazvn /f/\[modWorks\]/fallout4-vortex/ "/c/Users/zeruel11/AppData/Roaming/Vortex/fallout4" --delete
			rsync -Cuazvn --filter="merge .filter-ESP" /f/\[modWorks\]/esps/ "/d/FO4/Data/" --delete | tee ~/sync-modWorks.DRY_RUN.log
			echo -e '\e[41;97mThis dry run MUST be used as \e[1mREFERENCE\e[0m'
		fi
	elif [ -d "/j/gaming/" ]; then
		rsync -Cuazvn /d/WorkSpace/\=modding\=/FO4/Data/ "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" | tee ~/sync-modWorks.DRY_RUN.log
		echo 'due to the complex nature of modding it is A MUST that you copy the resulting files manually'
	elif [ -d "/d/FO4/" ]; then
		if [ "$2" == 'confirm' ]; then
			rsync -Cuazv --progress /d/_modWorks/\=modding\=/FO4/Data/ /d/FO4/Data/ | tee ~/sync-modWorks.X230-pull.log
		else
			rsync -Cuazvn --progress /d/_modWorks/\=modding\=/FO4/Data/ /d/FO4/Data/ | tee ~/sync-modWorks.DRY_RUN.log
			echo -e '\e[41;97mThis dry run MUST be used as \e[1mREFERENCE\e[0m'
		fi
	else
		echo -e '\e[31mNo source and nowhere to pull :(\e[0m'
	fi
elif [ "$1" == 'export' ]; then
	if [ -z "$2" ]; then
		cp -v /d/WorkSpace/\=modding\=/FO4/BodySlideResult/* /c/Users/zeruel/Desktop/
	else
		cp -v /d/WorkSpace/\=modding\=/FO4/BodySlideResult/* $2
	fi
elif [ "$1" == 'master' ]; then
	if [ -d "/k/[modWorks]/" ]; then
		rsync -Cuazv --filter="merge .filter-espBA2" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /k/\[modWorks\]/esps/ --delete --delete-excluded
	else
		echo -e "\e[41mYour portable flashdisk is not present or uses a different drive map\e[0m"
	fi
	if [ -d "/g/modSource/" ]; then
		rsync -Cuazv --filter="merge .filter-MasterSync" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /g/modSource/Data/ --delete --delete-excluded
	else
		echo -e "\e[41mYour portable harddisk is not present or uses a different drive map\e[0m"
	fi
elif [ "$1" == 'push' ]; then
	if [ -z "$2" ]; then
		read -p "Do you want to push model or esp? " whattopush
	else
		whattopush="$2"
	fi
	if [ "$FO4" == "portable" ]; then
		if [ "$whattopush" == "esp" ]; then
			rsync -cazv /d/FO4/Data/myCompatibilityPatches.esp "/d/_modWorks/=modding=/FO4/"
		elif [ "$whattopush" == "model" ]; then
			previewFull=$(rsync -Ccazvvn --filter="merge .filter-Data" --prune-empty-dirs "/d/FO4/Data/" /d/_modWorks/\=modding\=/FO4/Data/ --delete-before --delete-excluded --max-size=300m)
			echo "$previewFull" | grep -v 'sender' | GREP_COLORS='mt=1;31' egrep --color=always '.*(over max-size)|$' | GREP_COLORS='mt=1;34' egrep --color=always '.*\.esp|$' | less -R
			read -p "Confirm push? [yes] " userConfirm
			if [ "$userConfirm" == "yes" ]; then
				rsync -Ccazvv --filter="merge .filter-Data" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /d/WorkSpace/\=modding\=/FO4/Data/ --delete-before --delete-excluded --max-size=300m | tee sync-modWorks.X230-push.log
			fi
		fi
	elif [ "$FO4" == "main" ]; then
		if [ "$whattopush" == "esp" ]; then
			echo -e "\e[34mCopying myCompatibilityPatches.esp...\e[0m"
			rsync -cazv "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/myCompatibilityPatches.esp" "/d/WorkSpace/=modding=/FO4/Data/"
		elif [ "$whattopush" == "model" ]; then
			previewFull=$(rsync -Ccazvvn --filter="merge .filter-Data" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /d/WorkSpace/\=modding\=/FO4/Data/ --delete-before --delete-excluded --max-size=300m)
			echo "$previewFull" | grep -v 'sender' | GREP_COLORS='mt=1;31' egrep --color=always '.*(over max-size)|$' | GREP_COLORS='mt=1;34' egrep --color=always '.*\.esp|$' | less -R
			read -p "Confirm push? [yes] " userConfirm
			if [ "$userConfirm" == "yes" ]; then
				rsync -Ccazvv --filter="merge .filter-Data" --prune-empty-dirs "/j/gaming/illegal, no-drm, and freebies/Fallout 4/Data/" /d/WorkSpace/\=modding\=/FO4/Data/ --delete-before --delete-excluded --max-size=300m | tee sync-modWorks.X230-push.log
			# else
			# 	echo -e "\e[34mSynchronization canceled...\e[0m"
			fi
		else
			echo -e "You're neither at your pc nor your laptop... \e[31mWho or where the fluff are you?!\e[0m"
		fi
	fi
else
	echo 'you have to specify pull or push (mastersync), or export to Desktop'
fi
